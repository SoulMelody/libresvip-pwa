import{r as h,m as Ke,x as V,aL as Z,v as ue,O as Je,y as Qe,j as v,c as A,cj as Ze,ck as et,cl as tt,c5 as it,l as rt,c8 as Re,cm as st,cn as nt,co as ot,L as at,cp as lt,cq as dt,cr as ct,b$ as ht,cs as ut,E as Y,_ as K}from"./index-BXy9S0ZG.js";import{k as pt,h as Se}from"./Toolbar-DwupCvdF-D3M7JP7B-Cc0ZFnXH.js";import{a as mt,l as ft}from"./FormClearHelper-DSORW5o1-C9o5k7P7-CT8OSwJM.js";import{o as gt}from"./createDownloadLinkElement-CbRjLJ8e-BjJEUuqX-BXneJz2V.js";import{c as vt}from"./Hooks-BLb3umpI-DKif_5q7-BW6UBtMn.js";import{a as bt,i as yt}from"./FileDownload.esm-CV5-Gba--CRvvl245-C9izKCBC.js";var Te=h.forwardRef(function(r,e){var t={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return h.createElement(Y,K({iconAttrs:t,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},r,{ref:e}),h.createElement("g",{fill:"none"},h.createElement("rect",{width:24,height:24}),h.createElement("rect",{width:24,height:24}),h.createElement("rect",{width:24,height:24})),h.createElement("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),h.createElement("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"}))});Te.displayName="Mic";var Ae=h.forwardRef(function(r,e){var t={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return h.createElement(Y,K({iconAttrs:t,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},r,{ref:e}),h.createElement("rect",{width:24,height:24,fill:"none"}),h.createElement("path",{d:"M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"}))});Ae.displayName="Pause";var Le=h.forwardRef(function(r,e){var t={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return h.createElement(Y,K({iconAttrs:t,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},r,{ref:e}),h.createElement("rect",{width:24,height:24,fill:"none"}),h.createElement("path",{d:"M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18a1 1 0 000-1.69L9.54 5.98A.998.998 0 008 6.82z"}))});Le.displayName="PlayArrow";var Oe=h.forwardRef(function(r,e){var t={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return h.createElement(Y,K({iconAttrs:t,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},r,{ref:e}),h.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),h.createElement("path",{d:"M17.65 6.35a7.95 7.95 0 00-6.48-2.31c-3.67.37-6.69 3.35-7.1 7.02C3.52 15.91 7.27 20 12 20a7.98 7.98 0 007.21-4.56c.32-.67-.16-1.44-.9-1.44-.37 0-.72.2-.88.53a5.994 5.994 0 01-6.8 3.31c-2.22-.49-4.01-2.3-4.48-4.52A6.002 6.002 0 0112 6c1.66 0 3.14.69 4.22 1.78l-1.51 1.51c-.63.63-.19 1.71.7 1.71H19c.55 0 1-.45 1-1V6.41c0-.89-1.08-1.34-1.71-.71l-.64.65z"}))});Oe.displayName="Refresh";var je=h.forwardRef(function(r,e){var t={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return h.createElement(Y,K({iconAttrs:t,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},r,{ref:e}),h.createElement("g",{fill:"none"},h.createElement("rect",{width:24,height:24}),h.createElement("rect",{width:24,height:24})),h.createElement("path",{fillRule:"evenodd",d:"M9 16h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1H9c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1zm3-14C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"}))});je.displayName="StopCircle";function T(r,e,t,i){return new(t||(t=Promise))(function(s,n){function d(a){try{c(i.next(a))}catch(o){n(o)}}function l(a){try{c(i.throw(a))}catch(o){n(o)}}function c(a){var o;a.done?s(a.value):(o=a.value,o instanceof t?o:new t(function(m){m(o)})).then(d,l)}c((i=i.apply(r,e||[])).next())})}let J=class{constructor(){this.listeners={}}on(r,e,t){if(this.listeners[r]||(this.listeners[r]=new Set),t?.once){const i=(...s)=>{this.un(r,i),e(...s)};return this.listeners[r].add(i),()=>this.un(r,i)}return this.listeners[r].add(e),()=>this.un(r,e)}un(r,e){var t;(t=this.listeners[r])===null||t===void 0||t.delete(e)}once(r,e){return this.on(r,e,{once:!0})}unAll(){this.listeners={}}emit(r,...e){this.listeners[r]&&this.listeners[r].forEach(t=>t(...e))}};const ee={decode:function(r,e){return T(this,void 0,void 0,function*(){const t=new AudioContext({sampleRate:e});try{return yield t.decodeAudioData(r)}finally{t.close()}})},createBuffer:function(r,e){if(!r||r.length===0)throw new Error("channelData must be a non-empty array");if(e<=0)throw new Error("duration must be greater than 0");if(typeof r[0]=="number"&&(r=[r]),!r[0]||r[0].length===0)throw new Error("channelData must contain non-empty channel arrays");(function(i){const s=i[0];if(s.some(n=>n>1||n<-1)){const n=s.length;let d=0;for(let l=0;l<n;l++){const c=Math.abs(s[l]);c>d&&(d=c)}for(const l of i)for(let c=0;c<n;c++)l[c]/=d}})(r);const t=r.map(i=>i instanceof Float32Array?i:Float32Array.from(i));return{duration:e,length:t[0].length,sampleRate:t[0].length/e,numberOfChannels:t.length,getChannelData:i=>{const s=t[i];if(!s)throw new Error(`Channel ${i} not found`);return s},copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}};function Ue(r,e){const t=e.xmlns?document.createElementNS(e.xmlns,r):document.createElement(r);for(const[i,s]of Object.entries(e))if(i==="children"&&s)for(const[n,d]of Object.entries(s))d instanceof Node?t.appendChild(d):typeof d=="string"?t.appendChild(document.createTextNode(d)):t.appendChild(Ue(n,d));else i==="style"?Object.assign(t.style,s):i==="textContent"?t.textContent=s:t.setAttribute(i,s.toString());return t}function Ee(r,e,t){const i=Ue(r,e||{});return t?.appendChild(i),i}var wt=Object.freeze({__proto__:null,createElement:Ee,default:Ee});const Ct={fetchBlob:function(r,e,t){return T(this,void 0,void 0,function*(){const i=yield fetch(r,t);if(i.status>=400)throw new Error(`Failed to fetch ${r}: ${i.status} (${i.statusText})`);return(function(s,n){T(this,void 0,void 0,function*(){if(!s.body||!s.headers)return;const d=s.body.getReader(),l=Number(s.headers.get("Content-Length"))||0;let c=0;const a=o=>{c+=o?.length||0;const m=Math.round(c/l*100);n(m)};try{for(;;){const o=yield d.read();if(o.done)break;a(o.value)}}catch(o){console.warn("Progress tracking error:",o)}})})(i.clone(),e),i.blob()})}};class xt extends J{constructor(e){super(),this.isExternalMedia=!1,e.media?(this.media=e.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),e.mediaControls&&(this.media.controls=!0),e.autoplay&&(this.media.autoplay=!0),e.playbackRate!=null&&this.onMediaEvent("canplay",()=>{e.playbackRate!=null&&(this.media.playbackRate=e.playbackRate)},{once:!0})}onMediaEvent(e,t,i){return this.media.addEventListener(e,t,i),()=>this.media.removeEventListener(e,t,i)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const e=this.getSrc();e.startsWith("blob:")&&URL.revokeObjectURL(e)}canPlayType(e){return this.media.canPlayType(e)!==""}setSrc(e,t){const i=this.getSrc();if(e&&i===e)return;this.revokeSrc();const s=t instanceof Blob&&(this.canPlayType(t.type)||!e)?URL.createObjectURL(t):e;if(i&&this.media.removeAttribute("src"),s||e)try{this.media.src=s}catch{this.media.src=e}}destroy(){this.isExternalMedia||(this.media.pause(),this.revokeSrc(),this.media.removeAttribute("src"),this.media.load(),this.media.remove())}setMediaElement(e){this.media=e}play(){return T(this,void 0,void 0,function*(){try{return yield this.media.play()}catch(e){if(e instanceof DOMException&&e.name==="AbortError")return;throw e}})}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(e){this.media.currentTime=Math.max(0,Math.min(e,this.getDuration()))}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(e){this.media.volume=e}getMuted(){return this.media.muted}setMuted(e){this.media.muted=e}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(e,t){t!=null&&(this.media.preservesPitch=t),this.media.playbackRate=e}getMediaElement(){return this.media}setSinkId(e){return this.media.setSinkId(e)}}function oe(r){return r<0?0:r>1?1:r}function Rt({maxTop:r,maxBottom:e,halfHeight:t,vScale:i}){const s=Math.round(r*t*i);return{topHeight:s,totalHeight:s+Math.round(e*t*i)||1}}function St({barAlign:r,halfHeight:e,topHeight:t,totalHeight:i,canvasHeight:s}){return r==="top"?0:r==="bottom"?s-i:e-t}function Pe(r,e,t){const i=e-r.left,s=t-r.top;return[i/r.width,s/r.height]}function Ie(r){return!!(r.barWidth||r.barGap||r.barAlign)}function We(r,e){if(!Ie(e))return r;const t=e.barWidth||.5,i=t+(e.barGap||t/2);return i===0?r:Math.floor(r/i)*i}function ke({scrollLeft:r,totalWidth:e,numCanvases:t}){if(e===0)return[0];const i=r/e,s=Math.floor(i*t);return[s-1,s,s+1]}function De({scrollLeft:r,clientWidth:e,scrollWidth:t}){return t===0?{startX:0,endX:0}:{startX:r/t,endX:(r+e)/t}}class Et extends J{constructor(e,t){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.unsubscribeOnScroll=[],this.dragUnsubscribe=null,this.subscriptions=[],this.options=e;const i=this.parentFromOptionsContainer(e.container);this.parent=i;const[s,n]=this.initHtml();i.appendChild(s),this.container=s,this.scrollContainer=n.querySelector(".scroll"),this.wrapper=n.querySelector(".wrapper"),this.canvasWrapper=n.querySelector(".canvases"),this.progressWrapper=n.querySelector(".progress"),this.cursor=n.querySelector(".cursor"),t&&n.appendChild(t),this.initEvents()}parentFromOptionsContainer(e){let t;if(typeof e=="string"?t=document.querySelector(e):e instanceof HTMLElement&&(t=e),!t)throw new Error("Container not found");return t}initEvents(){if(this.wrapper.addEventListener("click",e=>{const t=this.wrapper.getBoundingClientRect(),[i,s]=Pe(t,e.clientX,e.clientY);this.emit("click",i,s)}),this.wrapper.addEventListener("dblclick",e=>{const t=this.wrapper.getBoundingClientRect(),[i,s]=Pe(t,e.clientX,e.clientY);this.emit("dblclick",i,s)}),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollContainer.addEventListener("scroll",()=>{const{scrollLeft:e,scrollWidth:t,clientWidth:i}=this.scrollContainer,{startX:s,endX:n}=De({scrollLeft:e,scrollWidth:t,clientWidth:i});this.emit("scroll",s,n,e,e+i)}),typeof ResizeObserver=="function"){const e=this.createDelay(100);this.resizeObserver=new ResizeObserver(()=>{e().then(()=>this.onContainerResize()).catch(()=>{})}),this.resizeObserver.observe(this.scrollContainer)}}onContainerResize(){const e=this.parent.clientWidth;e===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=e,this.reRender(),this.emit("resize"))}initDrag(){this.dragUnsubscribe||(this.dragUnsubscribe=(function(e,t,i,s,n=3,d=0,l=100){if(!e)return()=>{};const c=new Map,a=matchMedia("(pointer: coarse)").matches;let o=()=>{};const m=f=>{if(f.button!==d||(c.set(f.pointerId,f),c.size>1))return;let u=f.clientX,p=f.clientY,b=!1;const g=Date.now(),D=y=>{if(y.defaultPrevented||c.size>1||a&&Date.now()-g<l)return;const C=y.clientX,E=y.clientY,L=C-u,U=E-p;if(b||Math.abs(L)>n||Math.abs(U)>n){y.preventDefault(),y.stopPropagation();const F=e.getBoundingClientRect(),{left:O,top:N}=F;b||(i?.(u-O,p-N),b=!0),t(L,U,C-O,E-N),u=C,p=E}},W=y=>{if(c.delete(y.pointerId),b){const C=y.clientX,E=y.clientY,L=e.getBoundingClientRect(),{left:U,top:F}=L;s?.(C-U,E-F)}o()},k=y=>{c.delete(y.pointerId),y.relatedTarget&&y.relatedTarget!==document.documentElement||W(y)},R=y=>{b&&(y.stopPropagation(),y.preventDefault())},S=y=>{y.defaultPrevented||c.size>1||b&&y.preventDefault()};document.addEventListener("pointermove",D),document.addEventListener("pointerup",W),document.addEventListener("pointerout",k),document.addEventListener("pointercancel",k),document.addEventListener("touchmove",S,{passive:!1}),document.addEventListener("click",R,{capture:!0}),o=()=>{document.removeEventListener("pointermove",D),document.removeEventListener("pointerup",W),document.removeEventListener("pointerout",k),document.removeEventListener("pointercancel",k),document.removeEventListener("touchmove",S),setTimeout(()=>{document.removeEventListener("click",R,{capture:!0})},10)}};return e.addEventListener("pointerdown",m),()=>{o(),e.removeEventListener("pointerdown",m),c.clear()}})(this.wrapper,(e,t,i)=>{const s=this.wrapper.getBoundingClientRect().width;this.emit("drag",oe(i/s))},e=>{this.isDragging=!0;const t=this.wrapper.getBoundingClientRect().width;this.emit("dragstart",oe(e/t))},e=>{this.isDragging=!1;const t=this.wrapper.getBoundingClientRect().width;this.emit("dragend",oe(e/t))}),this.subscriptions.push(this.dragUnsubscribe))}initHtml(){const e=document.createElement("div"),t=e.attachShadow({mode:"open"}),i=this.options.cspNonce&&typeof this.options.cspNonce=="string"?this.options.cspNonce.replace(/"/g,""):"";return t.innerHTML=`
      <style${i?` nonce="${i}"`:""}>
        :host {
          user-select: none;
          min-width: 1px;
        }
        :host audio {
          display: block;
          width: 100%;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;
          pointer-events: none;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper" part="wrapper">
          <div class="canvases" part="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[e,t]}setOptions(e){if(this.options.container!==e.container){const t=this.parentFromOptionsContainer(e.container);t.appendChild(this.container),this.parent=t}e.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=e,this.reRender()}getWrapper(){return this.wrapper}getWidth(){return this.scrollContainer.clientWidth}getScroll(){return this.scrollContainer.scrollLeft}setScroll(e){this.scrollContainer.scrollLeft=e}setScrollPercentage(e){const{scrollWidth:t}=this.scrollContainer,i=t*e;this.setScroll(i)}destroy(){var e;this.subscriptions.forEach(t=>t()),this.container.remove(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),(e=this.unsubscribeOnScroll)===null||e===void 0||e.forEach(t=>t()),this.unsubscribeOnScroll=[]}createDelay(e=10){let t,i;const s=()=>{t&&(clearTimeout(t),t=void 0),i&&(i(),i=void 0)};return this.timeouts.push(s),()=>new Promise((n,d)=>{s(),i=d,t=setTimeout(()=>{t=void 0,i=void 0,n()},e)})}getHeight(e,t){var i;const s=((i=this.audioData)===null||i===void 0?void 0:i.numberOfChannels)||1;return(function({optionsHeight:n,optionsSplitChannels:d,parentHeight:l,numberOfChannels:c,defaultHeight:a=128}){if(n==null)return a;const o=Number(n);if(!isNaN(o))return o;if(n==="auto"){const m=l||a;return d?.every(f=>!f.overlay)?m/c:m}return a})({optionsHeight:e,optionsSplitChannels:t,parentHeight:this.parent.clientHeight,numberOfChannels:s,defaultHeight:128})}convertColorValues(e){return(function(t,i){if(!Array.isArray(t))return t||"";if(t.length===0)return"#999";if(t.length<2)return t[0]||"";const s=document.createElement("canvas"),n=s.getContext("2d"),d=s.height*i,l=n.createLinearGradient(0,0,0,d||i),c=1/(t.length-1);return t.forEach((a,o)=>{l.addColorStop(o*c,a)}),l})(e,this.getPixelRatio())}getPixelRatio(){return e=window.devicePixelRatio,Math.max(1,e||1);var e}renderBarWaveform(e,t,i,s){const{width:n,height:d}=i.canvas,{halfHeight:l,barWidth:c,barRadius:a,barIndexScale:o,barSpacing:m}=(function({width:u,height:p,length:b,options:g,pixelRatio:D}){const W=p/2,k=g.barWidth?g.barWidth*D:1,R=g.barGap?g.barGap*D:g.barWidth?k/2:0,S=k+R||1;return{halfHeight:W,barWidth:k,barGap:R,barRadius:g.barRadius||0,barIndexScale:b>0?u/S/b:0,barSpacing:S}})({width:n,height:d,length:(e[0]||[]).length,options:t,pixelRatio:this.getPixelRatio()}),f=(function({channelData:u,barIndexScale:p,barSpacing:b,barWidth:g,halfHeight:D,vScale:W,canvasHeight:k,barAlign:R}){const S=u[0]||[],y=u[1]||S,C=S.length,E=[];let L=0,U=0,F=0;for(let O=0;O<=C;O++){const N=Math.round(O*p);if(N>L){const{topHeight:I,totalHeight:z}=Rt({maxTop:U,maxBottom:F,halfHeight:D,vScale:W}),B=St({barAlign:R,halfHeight:D,topHeight:I,totalHeight:z,canvasHeight:k});E.push({x:L*b,y:B,width:g,height:z}),L=N,U=0,F=0}const j=Math.abs(S[O]||0),X=Math.abs(y[O]||0);j>U&&(U=j),X>F&&(F=X)}return E})({channelData:e,barIndexScale:o,barSpacing:m,barWidth:c,halfHeight:l,vScale:s,canvasHeight:d,barAlign:t.barAlign});i.beginPath();for(const u of f)a&&"roundRect"in i?i.roundRect(u.x,u.y,u.width,u.height,a):i.rect(u.x,u.y,u.width,u.height);i.fill(),i.closePath()}renderLineWaveform(e,t,i,s){const{width:n,height:d}=i.canvas,l=(function({channelData:c,width:a,height:o,vScale:m}){const f=o/2,u=c[0]||[];return[u,c[1]||u].map((p,b)=>{const g=p.length,D=g?a/g:0,W=f,k=b===0?-1:1,R=[{x:0,y:W}];let S=0,y=0;for(let C=0;C<=g;C++){const E=Math.round(C*D);if(E>S){const U=W+(Math.round(y*f*m)||1)*k;R.push({x:S,y:U}),S=E,y=0}const L=Math.abs(p[C]||0);L>y&&(y=L)}return R.push({x:S,y:W}),R})})({channelData:e,width:n,height:d,vScale:s});i.beginPath();for(const c of l)if(c.length){i.moveTo(c[0].x,c[0].y);for(let a=1;a<c.length;a++){const o=c[a];i.lineTo(o.x,o.y)}}i.fill(),i.closePath()}renderWaveform(e,t,i){if(i.fillStyle=this.convertColorValues(t.waveColor),t.renderFunction)return void t.renderFunction(e,i);const s=(function({channelData:n,barHeight:d,normalize:l}){var c;const a=d||1;if(!l)return a;const o=n[0];if(!o||o.length===0)return a;let m=0;for(let f=0;f<o.length;f++){const u=(c=o[f])!==null&&c!==void 0?c:0,p=Math.abs(u);p>m&&(m=p)}return m?a/m:a})({channelData:e,barHeight:t.barHeight,normalize:t.normalize});Ie(t)?this.renderBarWaveform(e,t,i,s):this.renderLineWaveform(e,t,i,s)}renderSingleCanvas(e,t,i,s,n,d,l){const c=this.getPixelRatio(),a=document.createElement("canvas");a.width=Math.round(i*c),a.height=Math.round(s*c),a.style.width=`${i}px`,a.style.height=`${s}px`,a.style.left=`${Math.round(n)}px`,d.appendChild(a);const o=a.getContext("2d");if(t.renderFunction?(o.fillStyle=this.convertColorValues(t.waveColor),t.renderFunction(e,o)):this.renderWaveform(e,t,o),a.width>0&&a.height>0){const m=a.cloneNode(),f=m.getContext("2d");f.drawImage(a,0,0),f.globalCompositeOperation="source-in",f.fillStyle=this.convertColorValues(t.progressColor),f.fillRect(0,0,a.width,a.height),l.appendChild(m)}}renderMultiCanvas(e,t,i,s,n,d){const l=this.getPixelRatio(),{clientWidth:c}=this.scrollContainer,a=i/l,o=(function({clientWidth:p,totalWidth:b,options:g}){return We(Math.min(8e3,p,b),g)})({clientWidth:c,totalWidth:a,options:t});let m={};if(o===0)return;const f=p=>{if(p<0||p>=u||m[p])return;m[p]=!0;const b=p*o;let g=Math.min(a-b,o);if(g=We(g,t),g<=0)return;const D=(function({channelData:W,offset:k,clampedWidth:R,totalWidth:S}){return W.map(y=>{const C=Math.floor(k/S*y.length),E=Math.floor((k+R)/S*y.length);return y.slice(C,E)})})({channelData:e,offset:b,clampedWidth:g,totalWidth:a});this.renderSingleCanvas(D,t,g,s,b,n,d)},u=Math.ceil(a/o);if(!this.isScrollable){for(let p=0;p<u;p++)f(p);return}if(ke({scrollLeft:this.scrollContainer.scrollLeft,totalWidth:a,numCanvases:u}).forEach(p=>f(p)),u>1){const p=this.on("scroll",()=>{const{scrollLeft:b}=this.scrollContainer;Object.keys(m).length>10&&(n.innerHTML="",d.innerHTML="",m={}),ke({scrollLeft:b,totalWidth:a,numCanvases:u}).forEach(g=>f(g))});this.unsubscribeOnScroll.push(p)}}renderChannel(e,t,i,s){var{overlay:n}=t,d=(function(o,m){var f={};for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&m.indexOf(u)<0&&(f[u]=o[u]);if(o!=null&&typeof Object.getOwnPropertySymbols=="function"){var p=0;for(u=Object.getOwnPropertySymbols(o);p<u.length;p++)m.indexOf(u[p])<0&&Object.prototype.propertyIsEnumerable.call(o,u[p])&&(f[u[p]]=o[u[p]])}return f})(t,["overlay"]);const l=document.createElement("div"),c=this.getHeight(d.height,d.splitChannels);l.style.height=`${c}px`,n&&s>0&&(l.style.marginTop=`-${c}px`),this.canvasWrapper.style.minHeight=`${c}px`,this.canvasWrapper.appendChild(l);const a=l.cloneNode();this.progressWrapper.appendChild(a),this.renderMultiCanvas(e,d,i,c,l,a)}render(e){return T(this,void 0,void 0,function*(){var t;this.timeouts.forEach(a=>a()),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);const i=this.getPixelRatio(),s=this.scrollContainer.clientWidth,{scrollWidth:n,isScrollable:d,useParentWidth:l,width:c}=(function({duration:a,minPxPerSec:o=0,parentWidth:m,fillParent:f,pixelRatio:u}){const p=Math.ceil(a*o),b=p>m,g=!!(f&&!b);return{scrollWidth:p,isScrollable:b,useParentWidth:g,width:(g?m:p)*u}})({duration:e.duration,minPxPerSec:this.options.minPxPerSec||0,parentWidth:s,fillParent:this.options.fillParent,pixelRatio:i});if(this.isScrollable=d,this.wrapper.style.width=l?"100%":`${n}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=e,this.emit("render"),this.options.splitChannels)for(let a=0;a<e.numberOfChannels;a++){const o=Object.assign(Object.assign({},this.options),(t=this.options.splitChannels)===null||t===void 0?void 0:t[a]);this.renderChannel([e.getChannelData(a)],o,c,a)}else{const a=[e.getChannelData(0)];e.numberOfChannels>1&&a.push(e.getChannelData(1)),this.renderChannel(a,this.options,c,0)}Promise.resolve().then(()=>this.emit("rendered"))})}reRender(){if(this.unsubscribeOnScroll.forEach(i=>i()),this.unsubscribeOnScroll=[],!this.audioData)return;const{scrollWidth:e}=this.scrollContainer,{right:t}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&e!==this.scrollContainer.scrollWidth){const{right:i}=this.progressWrapper.getBoundingClientRect(),s=(function(n){const d=2*n;return(d<0?Math.floor(d):Math.ceil(d))/2})(i-t);this.scrollContainer.scrollLeft+=s}}zoom(e){this.options.minPxPerSec=e,this.reRender()}scrollIntoView(e,t=!1){const{scrollLeft:i,scrollWidth:s,clientWidth:n}=this.scrollContainer,d=e*s,l=i,c=i+n,a=n/2;if(this.isDragging)d+30>c?this.scrollContainer.scrollLeft+=30:d-30<l&&(this.scrollContainer.scrollLeft-=30);else{(d<l||d>c)&&(this.scrollContainer.scrollLeft=d-(this.options.autoCenter?a:0));const o=d-i-a;t&&this.options.autoCenter&&o>0&&(this.scrollContainer.scrollLeft+=o)}{const o=this.scrollContainer.scrollLeft,{startX:m,endX:f}=De({scrollLeft:o,scrollWidth:s,clientWidth:n});this.emit("scroll",m,f,o,o+n)}}renderProgress(e,t){if(isNaN(e))return;const i=100*e;this.canvasWrapper.style.clipPath=`polygon(${i}% 0%, 100% 0%, 100% 100%, ${i}% 100%)`,this.progressWrapper.style.width=`${i}%`,this.cursor.style.left=`${i}%`,this.cursor.style.transform=this.options.cursorWidth?`translateX(-${e*this.options.cursorWidth}px)`:"",this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(e,t)}exportImage(e,t,i){return T(this,void 0,void 0,function*(){const s=this.canvasWrapper.querySelectorAll("canvas");if(!s.length)throw new Error("No waveform data");if(i==="dataURL"){const n=Array.from(s).map(d=>d.toDataURL(e,t));return Promise.resolve(n)}return Promise.all(Array.from(s).map(n=>new Promise((d,l)=>{n.toBlob(c=>{c?d(c):l(new Error("Could not export image"))},e,t)})))})}}class Pt extends J{constructor(){super(...arguments),this.animationFrameId=null,this.isRunning=!1}start(){if(this.isRunning)return;this.isRunning=!0;const e=()=>{this.isRunning&&(this.emit("tick"),this.animationFrameId=requestAnimationFrame(e))};e()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stop()}}class ae extends J{constructor(e=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=e,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return T(this,void 0,void 0,function*(){})}get src(){return this.currentSrc}set src(e){if(this.currentSrc=e,this._duration=void 0,!e)return this.buffer=null,void this.emit("emptied");fetch(e).then(t=>{if(t.status>=400)throw new Error(`Failed to fetch ${e}: ${t.status} (${t.statusText})`);return t.arrayBuffer()}).then(t=>this.currentSrc!==e?null:this.audioContext.decodeAudioData(t)).then(t=>{this.currentSrc===e&&(this.buffer=t,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())}).catch(t=>{console.error("WebAudioPlayer load error:",t)})}_play(){if(!this.paused)return;this.paused=!1,this.bufferNode&&(this.bufferNode.onended=null,this.bufferNode.disconnect()),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let e=this.playedDuration*this._playbackRate;(e>=this.duration||e<0)&&(e=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,e),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var e;this.paused=!0,(e=this.bufferNode)===null||e===void 0||e.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return T(this,void 0,void 0,function*(){this.paused&&(this._play(),this.emit("play"))})}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(e){const t=e-this.currentTime,i=this.bufferNode;i?.stop(this.audioContext.currentTime+t),i?.addEventListener("ended",()=>{i===this.bufferNode&&(this.bufferNode=null,this.pause())},{once:!0})}setSinkId(e){return T(this,void 0,void 0,function*(){return this.audioContext.setSinkId(e)})}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this.bufferNode&&(this.bufferNode.playbackRate.value=e)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(e){const t=!this.paused;t&&this._pause(),this.playedDuration=e/this._playbackRate,t&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var e,t;return(e=this._duration)!==null&&e!==void 0?e:((t=this.buffer)===null||t===void 0?void 0:t.duration)||0}set duration(e){this._duration=e}get volume(){return this.gainNode.gain.value}set volume(e){this.gainNode.gain.value=e,this.emit("volumechange")}get muted(){return this._muted}set muted(e){this._muted!==e&&(this._muted=e,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(e){return/^(audio|video)\//.test(e)}getGainNode(){return this.gainNode}getChannelData(){const e=[];if(!this.buffer)return e;const t=this.buffer.numberOfChannels;for(let i=0;i<t;i++)e.push(this.buffer.getChannelData(i));return e}removeAttribute(e){switch(e){case"src":this.src="";break;case"playbackRate":this.playbackRate=0;break;case"currentTime":this.currentTime=0;break;case"duration":this.duration=0;break;case"volume":this.volume=0;break;case"muted":this.muted=!1}}}const Wt={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8e3};class q extends xt{static create(e){return new q(e)}constructor(e){const t=e.media||(e.backend==="WebAudio"?new ae:void 0);super({media:t,mediaControls:e.mediaControls,autoplay:e.autoplay,playbackRate:e.audioRate}),this.plugins=[],this.decodedData=null,this.stopAtPosition=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.options=Object.assign({},Wt,e),this.timer=new Pt;const i=t?void 0:this.getMediaElement();this.renderer=new Et(this.options,i),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();const s=this.options.url||this.getSrc()||"";Promise.resolve().then(()=>{this.emit("init");const{peaks:n,duration:d}=this.options;(s||n&&d)&&this.load(s,n,d).catch(l=>{this.emit("error",l instanceof Error?l:new Error(String(l)))})})}updateProgress(e=this.getCurrentTime()){return this.renderer.renderProgress(e/this.getDuration(),this.isPlaying()),e}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",()=>{if(!this.isSeeking()){const e=this.updateProgress();this.emit("timeupdate",e),this.emit("audioprocess",e),this.stopAtPosition!=null&&this.isPlaying()&&e>=this.stopAtPosition&&this.pause()}}))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",()=>{const e=this.updateProgress();this.emit("timeupdate",e)}),this.onMediaEvent("play",()=>{this.emit("play"),this.timer.start()}),this.onMediaEvent("pause",()=>{this.emit("pause"),this.timer.stop(),this.stopAtPosition=null}),this.onMediaEvent("emptied",()=>{this.timer.stop(),this.stopAtPosition=null}),this.onMediaEvent("ended",()=>{this.emit("timeupdate",this.getDuration()),this.emit("finish"),this.stopAtPosition=null}),this.onMediaEvent("seeking",()=>{this.emit("seeking",this.getCurrentTime())}),this.onMediaEvent("error",()=>{var e;this.emit("error",(e=this.getMediaElement().error)!==null&&e!==void 0?e:new Error("Media error")),this.stopAtPosition=null}))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",(e,t)=>{this.options.interact&&(this.seekTo(e),this.emit("interaction",e*this.getDuration()),this.emit("click",e,t))}),this.renderer.on("dblclick",(e,t)=>{this.emit("dblclick",e,t)}),this.renderer.on("scroll",(e,t,i,s)=>{const n=this.getDuration();this.emit("scroll",e*n,t*n,i,s)}),this.renderer.on("render",()=>{this.emit("redraw")}),this.renderer.on("rendered",()=>{this.emit("redrawcomplete")}),this.renderer.on("dragstart",e=>{this.emit("dragstart",e)}),this.renderer.on("dragend",e=>{this.emit("dragend",e)}),this.renderer.on("resize",()=>{this.emit("resize")}));{let e;const t=this.renderer.on("drag",i=>{var s;if(!this.options.interact)return;this.renderer.renderProgress(i),clearTimeout(e);let n=0;const d=this.options.dragToSeek;this.isPlaying()?n=0:d===!0?n=200:d&&typeof d=="object"&&(n=(s=d.debounceTime)!==null&&s!==void 0?s:200),e=setTimeout(()=>{this.seekTo(i)},n),this.emit("interaction",i*this.getDuration()),this.emit("drag",i)});this.subscriptions.push(()=>{clearTimeout(e),t()})}}initPlugins(){var e;!((e=this.options.plugins)===null||e===void 0)&&e.length&&this.options.plugins.forEach(t=>{this.registerPlugin(t)})}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach(e=>e()),this.mediaSubscriptions=[]}setOptions(e){this.options=Object.assign({},this.options,e),e.duration&&!e.peaks&&(this.decodedData=ee.createBuffer(this.exportPeaks(),e.duration)),e.peaks&&e.duration&&(this.decodedData=ee.createBuffer(e.peaks,e.duration)),this.renderer.setOptions(this.options),e.audioRate&&this.setPlaybackRate(e.audioRate),e.mediaControls!=null&&(this.getMediaElement().controls=e.mediaControls)}registerPlugin(e){if(this.plugins.includes(e))return e;e._init(this),this.plugins.push(e);const t=e.once("destroy",()=>{this.plugins=this.plugins.filter(i=>i!==e),this.subscriptions=this.subscriptions.filter(i=>i!==t)});return this.subscriptions.push(t),e}unregisterPlugin(e){this.plugins=this.plugins.filter(t=>t!==e),e.destroy()}getWrapper(){return this.renderer.getWrapper()}getWidth(){return this.renderer.getWidth()}getScroll(){return this.renderer.getScroll()}setScroll(e){return this.renderer.setScroll(e)}setScrollTime(e){const t=e/this.getDuration();this.renderer.setScrollPercentage(t)}getActivePlugins(){return this.plugins}loadAudio(e,t,i,s){return T(this,void 0,void 0,function*(){var n;if(this.emit("load",e),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,this.stopAtPosition=null,(n=this.abortController)===null||n===void 0||n.abort(),this.abortController=null,!t&&!i){const l=this.options.fetchParams||{};window.AbortController&&!l.signal&&(this.abortController=new AbortController,l.signal=this.abortController.signal);const c=o=>this.emit("loading",o);t=yield Ct.fetchBlob(e,c,l);const a=this.options.blobMimeType;a&&(t=new Blob([t],{type:a}))}this.setSrc(e,t);const d=yield new Promise(l=>{const c=s||this.getDuration();c?l(c):this.mediaSubscriptions.push(this.onMediaEvent("loadedmetadata",()=>l(this.getDuration()),{once:!0}))});if(!e&&!t){const l=this.getMediaElement();l instanceof ae&&(l.duration=d)}if(i)this.decodedData=ee.createBuffer(i,d||0);else if(t){const l=yield t.arrayBuffer();this.decodedData=yield ee.decode(l,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())})}load(e,t,i){return T(this,void 0,void 0,function*(){try{return yield this.loadAudio(e,void 0,t,i)}catch(s){throw this.emit("error",s),s}})}loadBlob(e,t,i){return T(this,void 0,void 0,function*(){try{return yield this.loadAudio("",e,t,i)}catch(s){throw this.emit("error",s),s}})}zoom(e){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(e),this.emit("zoom",e)}getDecodedData(){return this.decodedData}exportPeaks({channels:e=2,maxLength:t=8e3,precision:i=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const s=Math.min(e,this.decodedData.numberOfChannels),n=[];for(let d=0;d<s;d++){const l=this.decodedData.getChannelData(d),c=[],a=l.length/t;for(let o=0;o<t;o++){const m=l.slice(Math.floor(o*a),Math.ceil((o+1)*a));let f=0;for(let u=0;u<m.length;u++){const p=m[u];Math.abs(p)>Math.abs(f)&&(f=p)}c.push(Math.round(f*i)/i)}n.push(c)}return n}getDuration(){let e=super.getDuration()||0;return e!==0&&e!==1/0||!this.decodedData||(e=this.decodedData.duration),e}toggleInteraction(e){this.options.interact=e}setTime(e){this.stopAtPosition=null,super.setTime(e),this.updateProgress(e),this.emit("timeupdate",e)}seekTo(e){const t=this.getDuration()*e;this.setTime(t)}play(e,t){const i=Object.create(null,{play:{get:()=>super.play}});return T(this,void 0,void 0,function*(){e!=null&&this.setTime(e);const s=yield i.play.call(this);return t!=null&&(this.media instanceof ae?this.media.stopAt(t):this.stopAtPosition=t),s})}playPause(){return T(this,void 0,void 0,function*(){return this.isPlaying()?this.pause():this.play()})}stop(){this.pause(),this.setTime(0)}skip(e){this.setTime(this.getCurrentTime()+e)}empty(){this.load("",[[0]],.001)}setMediaElement(e){this.unsubscribePlayerEvents(),super.setMediaElement(e),this.initPlayerEvents()}exportImage(){return T(this,arguments,void 0,function*(e="image/png",t=1,i="dataURL"){return this.renderer.exportImage(e,t,i)})}destroy(){var e;this.emit("destroy"),(e=this.abortController)===null||e===void 0||e.abort(),this.plugins.forEach(t=>t.destroy()),this.subscriptions.forEach(t=>t()),this.unsubscribePlayerEvents(),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}q.BasePlugin=class extends J{constructor(r){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=r}onInit(){}_init(r){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=r,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(r=>r()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}},q.dom=wt;function le(r,e,t,i){return new(t||(t=Promise))(function(s,n){function d(a){try{c(i.next(a))}catch(o){n(o)}}function l(a){try{c(i.throw(a))}catch(o){n(o)}}function c(a){var o;a.done?s(a.value):(o=a.value,o instanceof t?o:new t(function(m){m(o)})).then(d,l)}c((i=i.apply(r,[])).next())})}class Be{constructor(){this.listeners={}}on(e,t,i){if(this.listeners[e]||(this.listeners[e]=new Set),i?.once){const s=(...n)=>{this.un(e,s),t(...n)};return this.listeners[e].add(s),()=>this.un(e,s)}return this.listeners[e].add(t),()=>this.un(e,t)}un(e,t){var i;(i=this.listeners[e])===null||i===void 0||i.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach(i=>i(...t))}}class kt extends Be{constructor(e){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=e}onInit(){}_init(e){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(e=>e()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}class Dt extends Be{constructor(){super(...arguments),this.animationFrameId=null,this.isRunning=!1}start(){if(this.isRunning)return;this.isRunning=!0;const e=()=>{this.isRunning&&(this.emit("tick"),this.animationFrameId=requestAnimationFrame(e))};e()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stop()}}const Mt=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class pe extends kt{constructor(e){var t,i,s,n,d,l;super(Object.assign(Object.assign({},e),{audioBitsPerSecond:(t=e.audioBitsPerSecond)!==null&&t!==void 0?t:128e3,scrollingWaveform:(i=e.scrollingWaveform)!==null&&i!==void 0&&i,scrollingWaveformWindow:(s=e.scrollingWaveformWindow)!==null&&s!==void 0?s:5,continuousWaveform:(n=e.continuousWaveform)!==null&&n!==void 0&&n,renderRecordedAudio:(d=e.renderRecordedAudio)===null||d===void 0||d,mediaRecorderTimeslice:(l=e.mediaRecorderTimeslice)!==null&&l!==void 0?l:void 0})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.micStream=null,this.recordedBlobUrl=null,this.timer=new Dt,this.subscriptions.push(this.timer.on("tick",()=>{const c=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+c,this.emit("record-progress",this.duration)}))}static create(e){return new pe(e||{})}renderMicStream(e){var t;const i=new AudioContext,s=i.createMediaStreamSource(e),n=i.createAnalyser();s.connect(n),this.options.continuousWaveform&&(n.fftSize=32);const d=n.frequencyBinCount,l=new Float32Array(d);let c=0;this.wavesurfer&&((t=this.originalOptions)!==null&&t!==void 0||(this.originalOptions=Object.assign({},this.wavesurfer.options)),this.wavesurfer.options.interact=!1,this.options.scrollingWaveform&&(this.wavesurfer.options.cursorWidth=0));const a=setInterval(()=>{var o,m,f,u;if(!this.isWaveformPaused){if(n.getFloatTimeDomainData(l),this.options.scrollingWaveform){const p=Math.floor((this.options.scrollingWaveformWindow||0)*i.sampleRate),b=Math.min(p,this.dataWindow?this.dataWindow.length+d:d),g=new Float32Array(p);if(this.dataWindow){const D=Math.max(0,p-this.dataWindow.length);g.set(this.dataWindow.slice(-b+d),D)}g.set(l,p-d),this.dataWindow=g}else if(this.options.continuousWaveform){if(!this.dataWindow){const b=this.options.continuousWaveformDuration?Math.round(100*this.options.continuousWaveformDuration):((m=(o=this.wavesurfer)===null||o===void 0?void 0:o.getWidth())!==null&&m!==void 0?m:0)*window.devicePixelRatio;this.dataWindow=new Float32Array(b)}let p=0;for(let b=0;b<d;b++){const g=Math.abs(l[b]);g>p&&(p=g)}if(c+1>this.dataWindow.length){const b=new Float32Array(2*this.dataWindow.length);b.set(this.dataWindow,0),this.dataWindow=b}this.dataWindow[c]=p,c++}else this.dataWindow=l;if(this.wavesurfer){const p=((u=(f=this.dataWindow)===null||f===void 0?void 0:f.length)!==null&&u!==void 0?u:0)/100;this.wavesurfer.load("",[this.dataWindow],this.options.scrollingWaveform?this.options.scrollingWaveformWindow:p).then(()=>{this.wavesurfer&&this.options.continuousWaveform&&(this.wavesurfer.setTime(this.getDuration()/1e3),this.wavesurfer.options.minPxPerSec||this.wavesurfer.setOptions({minPxPerSec:this.wavesurfer.getWidth()/this.wavesurfer.getDuration()}))}).catch(b=>{console.error("Error rendering real-time recording data:",b)})}}},10);return{onDestroy:()=>{clearInterval(a),s?.disconnect(),i?.close()},onEnd:()=>{this.isWaveformPaused=!0,this.stopMic()}}}startMic(e){return le(this,void 0,void 0,function*(){let t;this.micStream&&this.stopMic();try{t=yield navigator.mediaDevices.getUserMedia({audio:e==null||e})}catch(s){throw new Error("Error accessing the microphone: "+s.message)}const i=this.renderMicStream(t);return this.micStream=i,this.unsubscribeDestroy=this.once("destroy",i.onDestroy),this.unsubscribeRecordEnd=this.once("record-end",i.onEnd),this.stream=t,t})}stopMic(){var e,t,i;(e=this.micStream)===null||e===void 0||e.onDestroy(),(t=this.unsubscribeDestroy)===null||t===void 0||t.call(this),(i=this.unsubscribeRecordEnd)===null||i===void 0||i.call(this),this.micStream=null,this.unsubscribeDestroy=void 0,this.unsubscribeRecordEnd=void 0,this.stream&&(this.stream.getTracks().forEach(s=>s.stop()),this.stream=null,this.mediaRecorder=null)}startRecording(e){return le(this,void 0,void 0,function*(){const t=this.stream||(yield this.startMic(e));this.dataWindow=null;const i=this.mediaRecorder||new MediaRecorder(t,{mimeType:this.options.mimeType||Mt.find(d=>MediaRecorder.isTypeSupported(d)),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=i,this.stopRecording();const s=[];i.ondataavailable=d=>{d.data.size>0&&s.push(d.data),this.emit("record-data-available",d.data)};const n=d=>{var l;const c=new Blob(s,{type:i.mimeType});this.emit(d,c),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),this.recordedBlobUrl&&URL.revokeObjectURL(this.recordedBlobUrl),this.recordedBlobUrl=URL.createObjectURL(c),(l=this.wavesurfer)===null||l===void 0||l.load(this.recordedBlobUrl))};i.onpause=()=>n("record-pause"),i.onstop=()=>n("record-end"),i.start(this.options.mediaRecorderTimeslice),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")})}getDuration(){return this.duration}isRecording(){var e;return((e=this.mediaRecorder)===null||e===void 0?void 0:e.state)==="recording"}isPaused(){var e;return((e=this.mediaRecorder)===null||e===void 0?void 0:e.state)==="paused"}isActive(){var e;return((e=this.mediaRecorder)===null||e===void 0?void 0:e.state)!=="inactive"}stopRecording(){var e;this.isActive()&&((e=this.mediaRecorder)===null||e===void 0||e.stop(),this.timer.stop())}pauseRecording(){var e,t;this.isRecording()&&(this.isWaveformPaused=!0,(e=this.mediaRecorder)===null||e===void 0||e.requestData(),(t=this.mediaRecorder)===null||t===void 0||t.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var e;this.isPaused()&&(this.isWaveformPaused=!1,(e=this.mediaRecorder)===null||e===void 0||e.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return le(this,void 0,void 0,function*(){return navigator.mediaDevices.enumerateDevices().then(e=>e.filter(t=>t.kind==="audioinput"))})}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic(),this.recordedBlobUrl&&(URL.revokeObjectURL(this.recordedBlobUrl),this.recordedBlobUrl=null)}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.setOptions(this.originalOptions),delete this.originalOptions)}}const Tt=(r,e)=>{const{libConfig:{enforceDownloadInNewTab:t=!1}}=h.useContext(at);return h.useCallback(()=>{if(!r)return;const i=gt({enforceDownloadInNewTab:t,url:r,filename:e});i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)},[r,t,e])},de=({widgetMgr:r,id:e,formId:t,key:i,defaultValue:s})=>{h.useEffect(()=>{const o=r.getElementState(e,i);ue(o)&&V(s)&&r.setElementState(e,i,s)},[r,e,i,s]);const[n,d]=h.useState(r.getElementState(e,i)??s),l=h.useCallback(o=>{r.setElementState(e,i,o),d(o)},[r,e,i]),c=h.useMemo(()=>({formId:t||""}),[t]),a=h.useCallback(()=>l(s),[s,l]);return ft({element:c,widgetMgr:r,onFormCleared:a}),[n,l]},At=async({files:r,uploadClient:e,widgetMgr:t,widgetInfo:i,fragmentId:s})=>{let n=[];try{n=await e.fetchFileURLs(r)}catch(a){return{successfulUploads:[],failedUploads:r.map(o=>({file:o,error:Re(a)}))}}const d=st(r,n),l=[],c=[];return await Promise.all(d.map(async([a,o])=>{if(!a||!o?.uploadUrl||!o.fileId)return{file:a,fileUrl:o,error:new Error("No upload URL found")};try{await e.uploadFile({id:o.fileId,formId:i.formId||""},o.uploadUrl,a),l.push({fileUrl:o,file:a})}catch(m){const f=Re(m);c.push({file:a,error:f})}})),t.setFileUploaderStateValue(i,new nt({uploadedFileInfo:l.map(({file:a,fileUrl:o})=>new ot({fileId:o.fileId,fileUrls:o,name:a.webkitRelativePath||a.name,size:a.size}))}),{fromUi:!0},s),{successfulUploads:l,failedUploads:c}},Lt=A("div",{target:"e12wn80j14"})(""),Me=A("div",{target:"e12wn80j13"})(({theme:r,disabled:e})=>({height:r.sizes.largestElementHeight,width:"100%",background:r.colors.secondaryBg,borderRadius:r.radii.default,marginBottom:r.spacing.twoXS,display:"flex",alignItems:"center",position:"relative",paddingLeft:r.spacing.xs,paddingRight:r.spacing.sm,border:r.colors.widgetBorderColor?`${r.sizes.borderWidth} solid ${r.colors.widgetBorderColor}`:void 0,cursor:e?"not-allowed":"auto"}),""),Ot=A("div",{target:"e12wn80j12"})({name:"82a6rk",styles:"flex:1"}),jt=A("div",{target:"e12wn80j11"})(({show:r})=>({display:r?"block":"none"}),""),Ut=A("span",{target:"e12wn80j10"})(({theme:r,isPlayingOrRecording:e,disabled:t})=>({margin:r.spacing.sm,fontFamily:r.fonts.monospace,color:t?r.colors.fadedText40:e?r.colors.bodyText:r.colors.fadedText60,backgroundColor:r.colors.secondaryBg,fontSize:r.fontSizes.sm}),""),Fe=A("div",{target:"e12wn80j9"})({name:"1kyw74z",styles:"width:100%;text-align:center;overflow:hidden"}),Ne=A("span",{target:"e12wn80j8"})(({theme:r})=>({color:r.colors.bodyText}),""),It=A("a",{target:"e12wn80j7"})(({theme:r})=>({color:r.colors.link,textDecoration:r.linkUnderline?"underline":"none"}),""),Bt=A("div",{target:"e12wn80j6"})(({theme:r})=>({height:r.sizes.largestElementHeight,display:"flex",justifyContent:"center",alignItems:"center"}),""),Ft=A("div",{target:"e12wn80j5"})(({theme:r})=>{const e="0.625em";return{opacity:.2,width:"100%",height:e,backgroundSize:e,backgroundImage:`radial-gradient(${r.colors.fadedText10} 40%, transparent 40%)`,backgroundRepeat:"repeat"}},""),Nt=A("span",{target:"e12wn80j4"})(({theme:r})=>({"& > button":{color:r.colors.primary,padding:r.spacing.threeXS},"& > button:hover, & > button:focus":{color:r.colors.redColor}}),""),zt=A("span",{target:"e12wn80j3"})(({theme:r})=>({"& > button":{padding:r.spacing.threeXS,color:r.colors.fadedText60},"& > button:hover, & > button:focus":{color:r.colors.bodyText}}),""),ze=A("span",{target:"e12wn80j2"})(({theme:r})=>({"& > button":{padding:r.spacing.threeXS,color:r.colors.fadedText60},"& > button:hover, & > button:focus":{color:r.colors.bodyText}}),""),ce=A("div",{target:"e12wn80j1"})(({theme:r})=>({display:"flex",justifyContent:"center",alignItems:"center",flexGrow:0,flexShrink:1,padding:r.spacing.xs,gap:r.spacing.twoXS,marginRight:r.spacing.twoXS}),""),Ht=A("div",{target:"e12wn80j0"})(({theme:r})=>({marginLeft:r.spacing.sm}),""),G=({onClick:r,disabled:e,ariaLabel:t,iconContent:i})=>v.jsx(ct,{kind:ht.BORDERLESS_ICON,onClick:r,disabled:e,"aria-label":t,containerWidth:!0,"data-testid":"stAudioInputActionButton",children:v.jsx(ut,{content:i,size:"lg",color:"inherit"})}),$t=({disabled:r,stopRecording:e})=>v.jsx(Nt,{children:v.jsx(G,{onClick:e,disabled:r,ariaLabel:"Stop recording",iconContent:je})}),Vt=({disabled:r,isPlaying:e,onClickPlayPause:t})=>v.jsx(ze,{children:e?v.jsx(G,{onClick:t,disabled:r,ariaLabel:"Pause",iconContent:Ae}):v.jsx(G,{onClick:t,disabled:r,ariaLabel:"Play",iconContent:Le})}),_t=({disabled:r,startRecording:e})=>v.jsx(zt,{children:v.jsx(G,{onClick:e,disabled:r,ariaLabel:"Record",iconContent:Te})}),Xt=({onClick:r})=>v.jsx(ze,{children:v.jsx(G,{disabled:!1,onClick:r,ariaLabel:"Reset",iconContent:Oe})}),qt=({disabled:r,isRecording:e,isPlaying:t,isUploading:i,isError:s,recordingUrlExists:n,startRecording:d,stopRecording:l,onClickPlayPause:c,onClear:a})=>s?v.jsx(ce,{children:v.jsx(Xt,{onClick:a})}):i?v.jsx(ce,{children:v.jsx(lt,{"aria-label":"Uploading",size:"base",margin:"0",padding:"0"})}):v.jsxs(ce,{children:[e?v.jsx($t,{disabled:r,stopRecording:l}):v.jsx(_t,{disabled:r,startRecording:d}),n&&v.jsx(Vt,{disabled:r,isPlaying:t,onClickPlayPause:c})]}),Gt=h.memo(qt),Yt=()=>v.jsx(Fe,{children:v.jsx(Ne,{children:"An error has occurred, please try again."})}),Kt=h.memo(Yt),Jt=4,Qt=4,Zt=4,ei=8,ti=0,te="00:00",$=rt.getLogger("convertAudioToWav");async function ii(r,e){if(!r||r.size===0){$.error("Invalid or empty blob provided");return}if(!window.AudioContext){$.error("AudioContext not supported in this browser");return}const t=new AudioContext;let i;try{i=await r.arrayBuffer()}catch(m){$.error("Failed to read blob as ArrayBuffer",m),t.close();return}let s;try{s=await t.decodeAudioData(i)}catch(m){$.error("Failed to decode audio data",m),t.close();return}finally{t.close()}const n=e||s.sampleRate;if(n===s.sampleRate)return $.debug(`No resampling needed, sample rate is already ${n}Hz`),ie(s,n);$.debug(`Resampling from ${s.sampleRate}Hz to ${n}Hz`);const{duration:d,numberOfChannels:l}=s,c=Math.ceil(d*n);if(!window.OfflineAudioContext)return $.error("OfflineAudioContext not supported, falling back to no resampling"),ie(s,s.sampleRate);const a=new OfflineAudioContext(l,c,n),o=a.createBufferSource();o.buffer=s,o.connect(a.destination),o.start(0);try{const m=await a.startRendering();return ie(m,n)}catch(m){return $.error("Failed to resample audio using OfflineAudioContext",m),ie(s,s.sampleRate)}}function ie(r,e){const t=r.numberOfChannels,i=r.length*t*2+44,s=new ArrayBuffer(i),n=new DataView(s),d=(c,a)=>{for(let o=0;o<a.length;o++)n.setUint8(c+o,a.charCodeAt(o))};d(0,"RIFF"),n.setUint32(4,i-8,!0),d(8,"WAVE"),d(12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,t,!0),n.setUint32(24,e,!0),n.setUint32(28,e*t*2,!0),n.setUint16(32,t*2,!0),n.setUint16(34,16,!0),d(36,"data"),n.setUint32(40,i-44,!0);let l=44;for(let c=0;c<r.length;c++)for(let a=0;a<t;a++){const o=Math.max(-1,Math.min(1,r.getChannelData(a)[c]));n.setInt16(l,o*32767,!0),l+=2}return new Blob([s],{type:"audio/wav"})}const he=r=>{const e=Math.floor(r/1e3),t=Math.floor(e/60),i=Math.floor(t/60),s=e%60,n=t%60,d=s.toString().padStart(2,"0"),l=n.toString().padStart(2,"0"),c=i.toString().padStart(2,"0");return t<60?`${l}:${d}`:`${c}:${l}:${d}`},ri=()=>v.jsxs(Fe,{children:[v.jsx(Ne,{children:"This app would like to use your microphone."})," ",v.jsx(It,{href:dt,rel:"noopener noreferrer",target:"_blank",children:"Learn how to allow access."})]}),si=h.memo(ri),ni=()=>v.jsx(Bt,{children:v.jsx(Ft,{})}),oi=h.memo(ni),ai=({element:r,uploadClient:e,widgetMgr:t,fragmentId:i,disabled:s})=>{const n=Ke(),d=vt(n),[l,c]=h.useState(null),a=h.useRef(null),o=h.useRef(null),[m,f]=de({widgetMgr:t,id:r.id,key:"deleteFileUrl",defaultValue:null}),[u,p]=de({widgetMgr:t,id:r.id,key:"recordingUrl",defaultValue:null}),[,b]=h.useState(0),g=h.useCallback(()=>{b(w=>w+1)},[]),[D,W]=h.useState(te),[k,R]=de({widgetMgr:t,id:r.id,formId:r.formId,key:"recordingTime",defaultValue:te}),[S,y]=h.useState(!1),[C,E]=h.useState(!1),[L,U]=h.useState(!1),[F,O]=h.useState(!1),[N,j]=h.useState(!1),X=r.id,I=r.formId,z=r.sampleRate||null,B=h.useRef(null),re=h.useRef({}),me=h.useCallback(async w=>{try{O(!0),V(I)&&t.setFormsWithUploadsInProgress(new Set([I]));let x;if(w.type==="audio/wav"?x=w:x=await ii(w,z||void 0),!x){j(!0),O(!1),V(I)&&t.setFormsWithUploadsInProgress(new Set);return}let M;try{M=URL.createObjectURL(x),o.current&&o.current!==M&&URL.revokeObjectURL(o.current),o.current=M}catch{j(!0),O(!1),V(I)&&t.setFormsWithUploadsInProgress(new Set);return}p(M),l&&(l.load(M),l.setOptions({interact:!0,waveColor:Z(n.colors.fadedText40,n.colors.secondaryBg),progressColor:n.colors.bodyText}));const _=new Date().toISOString().slice(0,16).replace(/:/g,"-"),P=new File([x],`${_}_audio.wav`,{type:x.type});try{const{successfulUploads:Q,failedUploads:ne}=await At({files:[P],uploadClient:e,widgetMgr:t,widgetInfo:{id:X,formId:I},fragmentId:i});if(ne.length>0){j(!0);return}j(!1);const xe=Q[0];xe?.fileUrl?.deleteUrl&&f(xe.fileUrl.deleteUrl)}catch{j(!0)}finally{V(I)&&t.setFormsWithUploadsInProgress(new Set),O(!1)}}catch{j(!0),O(!1),V(I)&&t.setFormsWithUploadsInProgress(new Set)}},[e,t,l,X,I,i,f,z,p,n.colors.fadedText40,n.colors.secondaryBg,n.colors.bodyText]),H=h.useCallback(async({updateWidgetManager:w,deleteFile:x})=>{if(ue(l))return;const M=u;if(M&&o.current===M&&(URL.revokeObjectURL(M),o.current=null),p(null),f(null),W(te),R(te),y(!1),l.empty(),w&&t.setFileUploaderStateValue(r,{},{fromUi:!0},i),x&&m)try{await e.deleteFile(m)}catch{}V(M)&&URL.revokeObjectURL(M)},[m,u,e,l,r,t,i,R,f,p]);h.useEffect(()=>{if(ue(I))return;const w=new mt;return w.manageFormClearListener(t,I,()=>{H({updateWidgetManager:!0,deleteFile:!1})}),()=>w.disconnect()},[I,H,t]);const fe=h.useCallback(()=>{if(a.current===null)return;const w=q.create({container:a.current,waveColor:u?Z(n.colors.fadedText40,n.colors.secondaryBg):n.colors.primary,progressColor:n.colors.bodyText,height:Je(n.sizes.largestElementHeight)-2*Jt,barWidth:Qt,barGap:Zt,barRadius:ei,cursorWidth:ti,interact:!0}),x=P=>{W(he(P*1e3))},M=()=>{g()};w.on("timeupdate",x),w.on("pause",M),c(w),u&&(w.load(u),w.setOptions({interact:!0}));const _={renderRecordedAudio:!1,scrollingWaveform:!1,mimeType:"audio/webm"};try{const P=w.registerPlugin(pe.create(_));B.current=P;const Q=ne=>{R(he(ne))};P.on("record-progress",Q),re.current={handleRecordProgress:Q}}catch(P){P instanceof Error&&(P.name==="NotAllowedError"||P.name==="PermissionDeniedError")&&E(!0)}return()=>{if(B.current){B.current.isRecording()&&B.current.stopRecording();const P=re.current;P.handleRecordProgress&&B.current.un("record-progress",P.handleRecordProgress),B.current.destroy(),B.current=null,re.current={}}w&&(w.un("timeupdate",x),w.un("pause",M),w.destroy())}},[n,W,g,u,R,E]);h.useEffect(()=>fe(),[fe]),h.useEffect(()=>{Qe(d,n)||l?.setOptions({waveColor:u?Z(n.colors.fadedText40,n.colors.secondaryBg):n.colors.primary,progressColor:n.colors.bodyText,interact:!0})},[n,d,u,l]);const He=h.useCallback(()=>{l&&(async()=>{try{await l.playPause()}catch{j(!0)}y(!0),g()})()},[l,g]),ge=h.useCallback(async()=>{if(!L){U(!0);let w=null;try{w=await navigator.mediaDevices.getUserMedia({audio:!0})}catch{E(!0);return}finally{w&&w.getTracks().forEach(x=>x.stop())}}if(u&&await H({updateWidgetManager:!1,deleteFile:!0}),B.current&&l){l.setOptions({waveColor:n.colors.primary});const w=z?{sampleRate:{ideal:z}}:{};try{await B.current.startRecording(w),R(he(0)),g()}catch(x){x instanceof Error&&(x.name==="NotAllowedError"||x.name==="PermissionDeniedError")?E(!0):j(!0)}}else C||j(!0)},[L,R,C,z,l,n.colors.primary,g,u,H]),ve=h.useCallback(w=>new Promise((x,M)=>{const _=P=>{w.un("record-end",_),P&&P instanceof Blob&&P.size>0?x(P):M(new Error("Invalid or empty recording blob"))};w.on("record-end",_),w.stopRecording()}),[]),be=h.useCallback(async()=>{const w=B.current;if(w?.isRecording())try{const x=await ve(w);await me(x),l&&l.setOptions({waveColor:Z(n.colors.fadedText40,n.colors.secondaryBg),progressColor:n.colors.bodyText})}catch{j(!0)}},[me,l,n,ve]),ye=Tt(u,"recording.wav"),se=B.current?.isRecording()||!1,we=!!l?.isPlaying(),$e=se||we,Ce=!se&&!u&&!C,Ve=C||Ce||N,_e=h.useCallback(()=>{ge()},[ge]),Xe=h.useCallback(()=>{be()},[be]),qe=h.useCallback(()=>{H({updateWidgetManager:!1,deleteFile:!0}),j(!1)},[H]),Ge=h.useCallback(()=>{ye()},[ye]),Ye=h.useCallback(()=>{H({updateWidgetManager:!0,deleteFile:!0})},[H]);return v.jsxs(Lt,{className:"stAudioInput","data-testid":"stAudioInput",children:[v.jsx(Ze,{label:r.label,disabled:s,labelVisibility:et(r.labelVisibility?.value),children:r.help&&v.jsx(Ht,{children:v.jsx(tt,{content:r.help,placement:it.TOP})})}),v.jsxs(Me,{disabled:s,children:[v.jsxs(pt,{isFullScreen:!1,disableFullscreenMode:!0,target:Me,children:[u&&v.jsx(Se,{label:"Download as WAV",icon:bt,onClick:Ge}),m&&v.jsx(Se,{label:"Clear recording",icon:yt,onClick:Ye})]}),v.jsx(Gt,{isRecording:se,isPlaying:we,isUploading:F,isError:N,recordingUrlExists:!!u,startRecording:_e,stopRecording:Xe,onClickPlayPause:He,onClear:qe,disabled:s||C}),v.jsxs(Ot,{children:[N&&v.jsx(Kt,{}),Ce&&v.jsx(oi,{}),C&&v.jsx(si,{}),v.jsx(jt,{"data-testid":"stAudioInputWaveSurfer",ref:a,show:!Ve})]}),v.jsx(Ut,{isPlayingOrRecording:$e,disabled:s,"data-testid":"stAudioInputWaveformTimeCode",children:S?D:k})]})]})},mi=h.memo(ai);export{mi as default};
