import{r as a,l as J,E as _,_ as U,e as q,f as P,s as X,h as G,j as z,G as Y,S as K,i as Q,m as Z,n as ee,o as te,t as ne,p as j,q as re,v as T,w as se,x as A,y as $,D as ae,z as ie,A as k,B as I,C as oe}from"./index-BXy9S0ZG.js";import{E as ce,m as le}from"./withFullScreenWrapper-Dg0Awf9i-COlHnLQx-Bp_4iEIe.js";import{h as F,V as H,k as ue}from"./Toolbar-DwupCvdF-D3M7JP7B-Cc0ZFnXH.js";import{s as de}from"./index-63iycogk-8hBpw-Jk-CcXfZ4B6.js";import{l as fe}from"./FormClearHelper-DSORW5o1-C9o5k7P7-CT8OSwJM.js";import"./sprintf-D5E86llw-yUkJWEcD-CuWy5xoB.js";import"./checkbox-Dxl2YmNe-CYX1lqsr-CuTwlO8a.js";import"./createDownloadLinkElement-CbRjLJ8e-BjJEUuqX-BXneJz2V.js";import"./slicedToArray-DufnYpuP-Dm33nlg3-DmtlpYEl.js";import"./inherits-D0t4NnD4-B3o6Mc-f-B2t_lqEE.js";import"./createSuper-DyjlCwUw-BiTb64Ih-L14cEwuZ.js";import"./FileDownload.esm-CV5-Gba--CRvvl245-C9izKCBC.js";var W=a.forwardRef(function(n,t){var s={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return a.createElement(_,U({iconAttrs:s,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),a.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),a.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});W.displayName="InsertChart";var B=a.forwardRef(function(n,t){var s={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return a.createElement(_,U({iconAttrs:s,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),a.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),a.createElement("path",{d:"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z"}))});B.displayName="TableChart";const me=20;function he(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&T(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const ge=(n,t,s,r,u,c,l,g)=>{const e=JSON.parse(n);if(r==="streamlit"?e.config=j(e.config,c):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=j(e.config,c),e.usermeta.embedOptions.theme=void 0):e.config=re(e.config,c),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(l-40,0)),s&&(e.height=g),t&&(e.width=l,"vconcat"in e&&e.vconcat.forEach(f=>{f.width=l})),e.padding||(e.padding={}),T(e.padding.bottom)&&(e.padding.bottom=me),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return u.length>0&&he(e),e},pe=(n,t,s,r,u)=>{const c=Z(),{id:l,formId:g,spec:e,data:f,datasets:i,vegaLiteTheme:d,selectionMode:o}=n,p=a.useMemo(()=>o,[JSON.stringify(o)]),y=a.useMemo(()=>ge(e,r,u,d,p,c,t,s),[e,r,u,d,p,c,t,s]);return{id:l,formId:g,vegaLiteTheme:d,spec:y,selectionMode:p,data:f,datasets:i,useContainerWidth:r}},we={DATAFRAME_INDEX:"(index)"};function ve(n){return!n||n.dimensions.numDataRows===0?null:O(n)}function ye(n){const t=M(n);if(T(t))return null;const s={};for(const[r,u]of Object.entries(t))s[r]=O(u);return s}function M(n){if(n?.length===0)return null;const t={};return n.forEach(s=>{if(!s)return;const r=s.hasName?s.name:null;t[r]=s.data}),t}function O(n,t=0){if(n.dimensions.numDataRows===0)return[];const s=[],{numDataRows:r,numDataColumns:u,numIndexColumns:c}=n.dimensions,l=n.columnTypes[0]??void 0,g=l&&l.type===ae.INDEX&&(ie(l)||k(l)||I(l));for(let e=t;e<r;e++){const f={};if(g){const{content:i}=n.getCell(e,0);f[we.DATAFRAME_INDEX]=typeof i=="bigint"?Number(i):i}for(let i=0;i<u;i++){const d=i+c,{content:o,contentType:p}=n.getCell(e,d);if((o instanceof Date||typeof o=="number"&&Number.isFinite(o))&&(k(p)||I(p))&&!oe(p)){const y=new Date(o).getTimezoneOffset()*60*1e3;f[n.columnNames[0][d]]=o.valueOf()+y}else f[n.columnNames[0][d]]=typeof o=="bigint"?Number(o):o}s.push(f)}return s}const Ce=150,be=J.getLogger("useVegaLiteSelections"),Ee=(n,t,s)=>{const{id:r,formId:u,selectionMode:c}=n,l=a.useCallback(e=>{c.forEach(i=>{e.addSignalListener(i,se(Ce,(d,o)=>{const p=e.getState({data:(w,v)=>c.some(E=>`${E}_store`===w),recurse:!1});A(p)&&t.setElementState(r,"viewState",p);let y=o;"vlPoint"in o&&"or"in o.vlPoint&&(y=o.vlPoint.or);const D={id:r,formId:u},h=JSON.parse(t.getStringValue(D)||"{}"),m={selection:{...h?.selection||{},[d]:y||{}}};$(h,m)||t.setStringValue(D,JSON.stringify(m),{fromUi:!0},s)}))});const f=t.getElementState(r,"viewState");if(A(f))try{return e.setState(f)}catch(i){be.warn("Failed to restore view state",i)}return e},[r,c,t,u,s]),g=a.useCallback(()=>{const e={selection:{}};c.forEach(o=>{e.selection[o]={}});const f={id:r,formId:u},i=t.getStringValue(f),d=i?JSON.parse(i):e;$(d,e)||t.setStringValue(f,JSON.stringify(e),{fromUi:!0},s)},[r,u,s,c,t]);return{maybeConfigureSelections:l,onFormCleared:g}},L="source",Se=J.getLogger("useVegaEmbed");function xe(n,t,s){const r=a.useRef(null),u=a.useRef(null),c=a.useRef(L),l=a.useRef(null),g=a.useRef([]),{maybeConfigureSelections:e,onFormCleared:f}=Ee(n,t,s);fe({widgetMgr:t,element:n,onFormCleared:f});const{data:i,datasets:d}=n;a.useEffect(()=>{r.current===null&&(l.current=i,g.current=d)},[i,d]);const o=a.useCallback(()=>{u.current&&u.current(),u.current=null,r.current=null},[]),p=a.useCallback(async(h,m)=>{if(h.current===null)throw new Error("Element missing.");o();const w={ast:!0,expr:te,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:v,view:E,finalize:V}=await ee(h.current,m,w);r.current=e(E),u.current=V;const C=ye(g.current),S=C?Object.keys(C):[];if(S.length===1){const[b]=S;c.current=b}else S.length===0&&v.data&&(c.current=L);const x=ve(l.current);if(x&&r.current.insert(c.current,x),C)for(const[b,N]of Object.entries(C))r.current.insert(b,N);return await r.current.runAsync(),await r.current.resize().runAsync(),r.current},[o,e]),y=a.useCallback((h,m,w,v)=>{if(!v||v.dimensions.numDataRows===0){try{h.remove(m,ne)}finally{}return}if(!w||w.dimensions.numDataRows===0){h.insert(m,O(v));return}v.hash!==w.hash&&(h.data(m,O(v)),Se.info(`Had to clear the ${m} dataset before inserting data through Vega view.`))},[]),D=a.useCallback(async(h,m)=>{if(r.current===null)return null;const w=l.current,v=g.current;(w||h)&&y(r.current,c.current,w,h);const E=M(v)??{},V=M(m)??{};for(const[C,S]of Object.entries(V)){const x=C||c.current,b=E[x];y(r.current,x,b,S)}for(const C of Object.keys(E))!Object.hasOwn(V,C)&&C!==c.current&&y(r.current,C,null,null);return await r.current?.resize().runAsync(),l.current=h,g.current=m,r.current},[y]);return{createView:p,updateView:D,finalizeView:o}}function Ve(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const Ne=({disableFullscreenMode:n,element:t,fragmentId:s,widgetMgr:r,widthConfig:u,heightConfig:c})=>{const[l,g]=a.useState(!1),[e,f]=a.useState(!1),{expanded:i,height:d,width:o,expand:p,collapse:y}=q(le),{width:D,height:h,elementRef:m}=P([l],0),w=X(u)||t.useContainerWidth,v=G(c),E=Ve(t.spec),V=pe(t,E?o??0:D,(i?d:h)??0,i?!0:w,i?!0:v),{createView:C,updateView:S,finalizeView:x}=xe(V,r,s),{data:b,datasets:N,spec:R}=V;return a.useLayoutEffect(()=>(m.current!==null&&C(m,R),x),[C,x,R,o,d,l,m]),a.useEffect(()=>{S(b,N)},[b,N,S]),a.useEffect(()=>{b||N?.[0]?.data?f(!0):f(!1)},[b,N]),l?z.jsx(de,{data:b??N[0]?.data,height:d??h??void 0,customToolbarActions:[z.jsx(F,{label:"Show chart",icon:W,onClick:()=>{g(!1)}},"show-chart")]}):z.jsxs(H,{height:v?i?d:"100%":d,useContainerWidth:i?!0:w,children:[z.jsx(ue,{target:H,isFullScreen:i,onExpand:p,onCollapse:y,disableFullscreenMode:n,children:e&&z.jsx(F,{label:"Show data",icon:B,onClick:()=>{g(!0)}})}),z.jsx(Y,{styles:K}),z.jsx(Q,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:w,useContainerHeight:v,ref:m})]})},ze=ce(Ne),Le=a.memo(ze);export{K as StyledVegaLiteChartTooltips,j as applyStreamlitTheme,Le as default};
